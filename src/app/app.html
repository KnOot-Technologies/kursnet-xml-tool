<div class="container">
  
  <header style="display: flex; justify-content: space-between; align-items: center;">
    <div>
      <h1>KURSNET XML Tool</h1>
      <p>OpenQ-cat Editor</p>
    </div>
    <button (click)="toggleHelp()" class="btn-help">‚ùì Hilfe & Tags</button>
  </header>

  <div class="help-overlay" *ngIf="showHelp">
    <div class="help-modal">
      <div class="help-header">
        <h3>üìñ KURSNET Tag-Erkl√§rung</h3>
        <button (click)="toggleHelp()" class="btn-close">‚úï</button>
      </div>
      <div class="help-content">
        <table class="help-table">
          <tr *ngFor="let item of helpGlossary">
            <td class="tag-name">{{ item.tag }}</td>
            <td>{{ item.desc }}</td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <section class="card upload-section">
    <h2>1. XML Datei laden</h2>
    <input type="file" (change)="onFileSelected($event)" accept=".xml">
  </section>

  <section class="card" *ngIf="kursService.services().length > 0">
    <h2>2. Kurse bearbeiten ({{kursService.services().length}} Eintr√§ge gesamt)</h2>
    
    <div class="accordion-list">
      <div class="accordion-header-row">
        <div style="width: 50px;"></div>
        <div style="width: 10%;">ID</div>
        <div style="flex: 1;">Bildungsangebot (Mutter)</div>
        <div style="width: 150px; text-align:center;">Termine</div>
        <div style="width: 120px;">Status</div>
        <div style="width: 80px; text-align: right;">Aktion</div>
      </div>

      <div *ngFor="let group of groupedServices()" 
           class="accordion-item" 
           [class.open]="isExpanded(group.parent.PRODUCT_ID)"
           [class.has-warning]="getWarnings(group).length > 0">
        
        <div class="accordion-trigger" (click)="toggleRow(group.parent.PRODUCT_ID)">
          <div class="icon-arrow" [class.rotated]="isExpanded(group.parent.PRODUCT_ID)">‚ñ∂</div>
          <div class="col-id">{{ group.parent.PRODUCT_ID }}</div>
          
          <div class="col-title">
            <div style="display: flex; align-items: center; gap: 10px;">
              <strong>{{ group.parent.SERVICE_DETAILS.TITLE }}</strong>
              <span *ngIf="isFlexibleStart(group.parent)" class="badge-flex">üîÑ Regelm√§√üig</span>
            </div>
            <div *ngIf="getWarnings(group).length > 0" style="color: #d32f2f; font-size: 0.8rem; margin-top: 4px;">
              ‚ö†Ô∏è {{ getWarnings(group).length }} Problem(e) erkannt
            </div>
          </div>

          <div style="width: 150px; text-align:center;">
            <span class="badge-count">{{ group.children.length }} Termine</span>
          </div>

          <div class="col-status">
            <span *ngIf="getWarnings(group).length > 0" class="dot error" title="Fehler gefunden"></span>
            <span *ngIf="getWarnings(group).length === 0" class="dot success" title="Alles OK"></span>
          </div>

          <div class="col-action">
            <button (click)="$event.stopPropagation(); kursService.removeService(group.parent)" class="btn-icon delete">üóëÔ∏è</button>
          </div>
        </div>

        <div class="accordion-content" *ngIf="isExpanded(group.parent.PRODUCT_ID)">
          <div class="content-wrapper">
            
            <div *ngIf="getWarnings(group).length > 0" class="warning-box">
              <h4 style="margin: 0 0 5px 0;">‚ö†Ô∏è Bitte pr√ºfen:</h4>
              <ul style="margin: 0; padding-left: 20px;">
                <li *ngFor="let w of getWarnings(group)">{{ w }}</li>
              </ul>
            </div>

            <div class="detail-column left">
              <div class="form-group">
                <label>Titel des Angebots:</label>
                <input type="text" [(ngModel)]="group.parent.SERVICE_DETAILS.TITLE" class="form-input">
              </div>

              <div *ngIf="group.parent.SERVICE_DETAILS.ANNOUNCEMENT" 
                   style="background: #fff3e0; padding: 10px; border-radius: 4px; border: 1px solid #ffe0b2; margin-bottom: 15px;">
                <h4 style="margin: 0 0 5px 0; font-size: 0.9rem; color: #e65100;">üì¢ Sichtbarkeit (Announcement)</h4>
                <div style="display: flex; gap: 10px;">
                  <div style="flex: 1;">
                    <label style="font-size: 0.8rem;">Online ab:</label>
                    <input type="text" [(ngModel)]="group.parent.SERVICE_DETAILS.ANNOUNCEMENT.START_DATE" class="form-input small">
                  </div>
                  <div style="flex: 1;">
                    <label style="font-size: 0.8rem;">Online bis:</label>
                    <input type="text" [(ngModel)]="group.parent.SERVICE_DETAILS.ANNOUNCEMENT.END_DATE" class="form-input small">
                  </div>
                </div>
              </div>

              <div style="background: #e3f2fd; padding: 10px; border-radius: 4px; border: 1px solid #bbdefb; margin-bottom: 15px;">
                <h4 style="margin: 0 0 5px 0; font-size: 0.9rem; color: #0d47a1;">‚è≥ Zeitraum & Dauer</h4>
                <div style="display: flex; gap: 10px; align-items: flex-end;">
                  
                  <div style="flex: 2;">
                    <label style="font-size: 0.8rem;">Start:</label>
                    <input type="date" 
                           [ngModel]="group.parent.SERVICE_DETAILS.SERVICE_DATE.START_DATE" 
                           (ngModelChange)="group.parent.SERVICE_DETAILS.SERVICE_DATE.START_DATE = $event"
                           class="form-input small">
                  </div>

                  <div style="flex: 1;">
                    <label style="font-size: 0.8rem;">Wochen:</label>
                    <input type="number" 
                           placeholder="W" 
                           min="1"
                           (input)="calculateEndDate(group.parent, $event.target.value)"
                           class="form-input small" 
                           style="text-align: center; border-color: #2196f3;">
                  </div>

                  <div style="flex: 2;">
                    <label style="font-size: 0.8rem;">Ende (Auto):</label>
                    <input type="date" 
                           [(ngModel)]="group.parent.SERVICE_DETAILS.SERVICE_DATE.END_DATE" 
                           class="form-input small">
                  </div>

                </div>
              </div>
              
              <div style="margin: 15px 0;">
                <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" 
                         [checked]="isFlexibleStart(group.parent)" 
                         (change)="toggleFlexibleStart(group.parent, $event)">
                  Regelm√§√üiger Start (Laufender Einstieg)
                </label>
              </div>

              <div class="children-list">
                <h4 style="margin-top:0;">üìÖ Konkrete Termine & Orte</h4>
                
                <div *ngFor="let child of group.children" class="child-row">
                  <div class="child-id" title="{{child.PRODUCT_ID}}">{{ formatChildId(child.PRODUCT_ID) }}</div>
                  
                  <div class="child-dates" style="display: flex; gap: 5px; align-items: center;">
                    <input type="date" 
                           [(ngModel)]="child.SERVICE_DETAILS.SERVICE_DATE.START_DATE" 
                           title="Startdatum"
                           class="form-input small" 
                           style="width: 110px;">
                    
                    <input type="number" 
                           placeholder="W" 
                           min="1"
                           (input)="calculateEndDate(child, $event.target.value)"
                           title="Dauer in Wochen eingeben -> berechnet Ende"
                           class="form-input small" 
                           style="width: 50px; text-align: center; border: 1px solid #2196f3;">

                    <span style="color:#999">‚ûù</span>

                    <input type="date" 
                           [(ngModel)]="child.SERVICE_DETAILS.SERVICE_DATE.END_DATE" 
                           title="Enddatum"
                           class="form-input small" 
                           style="width: 110px;">
                  </div>

                  <button (click)="kursService.removeService(child)" class="btn-icon delete small">‚úï</button>
                </div>

                <button (click)="kursService.addTermin(group.parent)" class="btn-add-termin">‚ûï Neuen Termin hinzuf√ºgen</button>
                <div *ngIf="group.children.length === 0" style="color: #999; font-style: italic; margin-top:10px; font-size: 0.9rem;">
                  Keine konkreten Termine vorhanden.
                </div>
              </div>
            </div>

            <div class="detail-column right">
              <label>Beschreibung:</label>
              <textarea [(ngModel)]="group.parent.SERVICE_DETAILS.DESCRIPTION_LONG" rows="15" class="form-input" style="height: 100%;"></textarea>
              <div class="validation-info">
                Zeichen: {{ group.parent.SERVICE_DETAILS.DESCRIPTION_LONG?.length || 0 }} (Min: 44)
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="card export-section" *ngIf="kursService.rawData()">
    <h2>3. Exportieren</h2>
    <div class="export-grid">
      
      <div class="export-box box-blue" style="opacity: 0.5;">
        <h3>Gesamtlieferung</h3>
        <p>Aktuell gesperrt.</p>
        <button (click)="exportGesamt()" 
                disabled 
                class="btn-primary" 
                style="background-color: #666; border-color: #666; cursor: not-allowed;">
          üö´ Aktuell nicht m√∂glich
        </button>
      </div>

      <div class="export-box box-orange">
        <h3>Differenzlieferung</h3>
        <p>Nur √Ñnderungen & L√∂schungen.</p>
        <label>Sequenznummer:</label>
        <input type="number" [(ngModel)]="seqNumber" min="1" class="seq-input">
        
        <div *ngIf="kursService.deletedServiceIds.length > 0" class="delete-info">
          üóëÔ∏è {{ kursService.deletedServiceIds.length }} Kurs(e) zum L√∂schen markiert.
        </div>
        
        <button (click)="exportDifferenz()" class="btn-secondary">Differenz-XML speichern</button>
      </div>

    </div>
  </section>

</div>